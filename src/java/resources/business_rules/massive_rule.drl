dialect "mvel"

import java.math.BigDecimal;
import com.flowserve.system606.service.CalculationService;
import com.flowserve.system606.model.PerformanceObligation;
import java.util.logging.Logger;
global Logger logger;
global CalculationService calcService;

rule "Calculate EAC Change"

    // Needed only to support tab-out ajax requests on the UI.
    when
        // Pull input values needed for this calculation.
        pob : PerformanceObligation()
        eval(calcService.getCurrencyInputValue("ESTIMATED_COST_AT_COMPLETION", pob) != null)
        eval(calcService.getCurrencyInputValuePriorPeriod("ESTIMATED_COST_AT_COMPLETION", pob) != null)
    then
        estimatedCostAtCompletion = calcService.getCurrencyInputValue("ESTIMATED_COST_AT_COMPLETION", pob);
        estimatedCostAtCompletionPriorPeriod = calcService.getCurrencyInputValuePriorPeriod("ESTIMATED_COST_AT_COMPLETION", pob);
        changeInEstimate = estimatedCostAtCompletionPriorPeriod - estimatedCostAtCompletion;
        calcService.putCurrencyOutputValue("CHANGE_IN_ESTIMATED_COST_AT_COMPLETION", pob, changeInEstimate);
end

rule "Calculate Estimated Gross Profit and Margin"

    // Needed only to support tab-out ajax requests on the UI.
    when
        // Pull input values needed for this calculation.
        pob : PerformanceObligation()
        eval(calcService.getCurrencyInputValue("TRANSACTION_PRICE", pob) != null)
        eval(calcService.getCurrencyInputValuePriorPeriod("ESTIMATED_COST_AT_COMPLETION", pob) != null)
    then
        // Calculate all outputs possible using these inputs.
        transactionPrice = calcService.getCurrencyInputValue("TRANSACTION_PRICE", pob);
        estimatedCostAtCompletion = calcService.getCurrencyInputValue("ESTIMATED_COST_AT_COMPLETION", pob);
        estimatedGrossProfit =  transactionPrice - estimatedCostAtCompletion;
        calcService.putCurrencyOutputValue("ESTIMATED_GROSS_PROFIT", pob, estimatedGrossProfit);
        estimatedGrossMargin = estimatedGrossProfit / transactionPrice
        calcService.putCurrencyOutputValue("ESTIMATED_GROSS_MARGIN", pob, estimatedGrossMargin);
end
